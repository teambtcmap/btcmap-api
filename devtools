#!/bin/bash

case "$1" in
    db)
        if [ "$#" -eq 1 ]
        then
            sqlite3 ~/.local/share/btcmap/btcmap.db
        else
            sqlite3 ~/.local/share/btcmap/btcmap.db "$2"
        fi
        ;;

    log)
        if [ "$#" -eq 1 ]
        then
            sqlite3 ~/.local/share/btcmap/log.db
        else
            sqlite3 ~/.local/share/btcmap/log.db "$2"
        fi
        ;;

    fetch-db)
        rsync -v --progress --stats btcmap-api:.local/share/btcmap/btcmap.db* ~/.local/share/btcmap/
        ;;

    fetch-log)
        sqlite3_rsync -v --wal-only btcmap-api:.local/share/btcmap/log.db ~/.local/share/btcmap/log.db
        ;;

    deploy)
        cargo test \
            && cargo build --release \
            && rsync -v --progress --stats target/release/btcmap-api btcmap-api:/usr/local/bin/btcmap-api \
            && ssh btcmap-api 'systemctl restart btcmap-api.service'
        ;;

    gen-schema)
        # Generate schema.sql from migrations using temporary SQLite database
        rm -f /tmp/schema_gen.db
        for f in $(ls -1 migrations/*.sql | sort -V); do
            sqlite3 /tmp/schema_gen.db < "$f" 2>/dev/null
        done
        sqlite3 /tmp/schema_gen.db ".dump" > schema.sql
        rm -f /tmp/schema_gen.db
        ;;
esac
